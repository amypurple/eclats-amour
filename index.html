<!DOCTYPE html>
<html lang="fr">

  <head>
    <meta charset="UTF-8" />
    <title>Éclats d'Amour</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Permissions-Policy" content="interest-cohort=()" />
    <link rel="stylesheet" type="text/css" href="style.css" />
  </head>

  <body>
    <div id="fb-root"></div>
    <div id="wrapper">
      <h1>Éclats d'Amour<span>par Amy Bienvenu</span></h1>
      <div id="form-wrapper">
        <label for="receiverName">À qui envoyer l'éclat d'amour ?</label>
        <div id="input-button-wrapper">
          <input type="text" id="receiverName" value="Beauté" />
          <input type="hidden" id="senderName" value="La vie" />
          <button id="preview-button">Aperçu</button>
        </div>
        <script async defer crossorigin="anonymous"
          src="https://connect.facebook.net/fr_CA/sdk.js#xfbml=1&version=v16.0&appId=734144951415691&autoLogAppEvents=1"
          nonce="INA6wtTh"></script>
        <div class="fb-login-button" data-width="" data-size="" data-button-type="" data-layout=""
          data-auto-logout-link="true" data-use-continue-as="true"></div>
      </div>
      <div id="preview-wrapper">
        <img id="preview-image" src="paper.png" alt="Aperçu" />
        <button id="share-button">Partager</button>
        <div class="fb-like" data-share="true" data-width="450" data-show-faces="true"></div>
      </div>
    </div>
    <script>

      // JavaScript for the link with Facebook web app
      // Check login status
      function checkLoginState() {
        console.log("checkLoginState - FB.getLoginStatus");
        FB.getLoginStatus(
          function (response) {
            if (response.status === "connected") {
              console.log("checkLoginState - FB.getLoginStatus - CONNECTED");
              // User is logged in and has granted permissions
              document.getElementById("share-button").style.display = "block";
              FB.api('/me', 'GET', { fields: 'name' }, function (response) {
                document.getElementById("senderName").value = response.name;
                console.log("FB.api with GET name : " + response.name);
              });
            } else if (response.status === "not_authorized") {
              console.log("checkLoginState - FB.getLoginStatus - NOT AUTHORIZED");
              // User is logged in but has not granted permissions
              console.log("checkLoginState - FB.login");
              FB.login(
                function (response) {
                  if (response.authResponse) {
                    console.log("checkLoginState - FB.login - RESPONSE");
                    document.getElementById("share-button").style.display = "block";
                  } else {
                    console.log("checkLoginState - FB.login - NOT GRANTED");
                    // User has not granted permissions
                    document.getElementById("share-button").style.display = "none";
                    console.error("User has not granted permissions");
                  }
                },
                { scope: "public_profile" }
              );
              FB.api('/me', 'GET', { fields: 'name' }, function (response) {
                console.log("FB.api with GET name : " + response.name);
              });
            } else {
              console.log("checkLoginState - FB.getLoginStatus - FAILED");
              // User is not logged in
              document.getElementById("share-button").style.display = "none";
              console.error("User is not logged in");
            }
          },
          function (error) {
            console.error("Error occurred while getting login status: ");
            console.dir(error);
          }
        );
      }

      function sharePicture() {
        var canvas = document.getElementById("preview-image");
        console.log('canvas');
        console.dir(canvas);

        // convert canvas to data URL
        var dataURL = canvas.toDataURL("image/png");

        // remove the data URL prefix
        var base64Data = dataURL.replace(/^data:image\/(png|jpeg);base64,/, "");

        // convert base64 data to a Blob object
        var blob = b64toBlob(base64Data, "image/png");

        // upload the photo to the user's album
        FB.api(
          "/me/photos",
          "POST",
          {
            source: blob,
            no_story: true,
          },
          function (response) {
            if (response && !response.error) {
              // create a link to the uploaded photo
              var link = "https://www.facebook.com/photo.php?fbid=" + response.id;

              // create the Facebook post with the link to the uploaded photo
              FB.ui({
                method: "feed",
                link: link,
                caption: "Check out my awesome image!",
                description: "I created this using my awesome app.",
              });
            } else {
              console.log(response.error);
              alert("An error occurred while sharing your image on Facebook.");
            }
          }
        );
      }

      // convert a base64 string to a Blob object
      function b64toBlob(b64Data, contentType) {
        contentType = contentType || "";
        var sliceSize = 512;
        var byteCharacters = atob(b64Data);
        var byteArrays = [];
        for (var offset = 0; offset < byteCharacters.length; offset += sliceSize) {
          var slice = byteCharacters.slice(offset, offset + sliceSize);
          var byteNumbers = new Array(slice.length);
          for (var i = 0; i < slice.length; i++) {
            byteNumbers[i] = slice.charCodeAt(i);
          }
          var byteArray = new Uint8Array(byteNumbers);
          byteArrays.push(byteArray);
        }
        var blob = new Blob(byteArrays, { type: contentType });
        return blob;
      }


      window.fbAsyncInit = function () {
        FB.init({
          appId: "734144951415691",
          xfbml: true,
          version: "v16.0",
        });
        console.log("fbAsyncInit - FB.AppEvents.logPageView");
        FB.AppEvents.logPageView();
        // Check login status
        checkLoginState();
      };

      (function (d, s, id) {
        var js,
          fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) {
          return;
        }
        js = d.createElement(s);
        js.id = id;
        js.src = "https://connect.facebook.net/en_US/sdk.js";
        fjs.parentNode.insertBefore(js, fjs);
      })(document, "script", "facebook-jssdk");
    </script>
    <script src="app.js"></script>
  </body>

</html>
